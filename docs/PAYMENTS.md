# ğŸ’³ æ”¯ä»˜ç³»çµ±å®Œæ•´æ–‡ä»¶

**æœ€å¾Œæ›´æ–°**: 2025-12-05

---

## ğŸ“‹ ç›®éŒ„

1. [æ•´åˆè¦åŠƒ](#æ•´åˆè¦åŠƒ)
2. [æ¸¬è©¦æŒ‡å—](#æ¸¬è©¦æŒ‡å—)
3. [æ¸¬è©¦å ±å‘Š](#æ¸¬è©¦å ±å‘Š)
4. [å·²çŸ¥å•é¡Œ](#å·²çŸ¥å•é¡Œ)

---

## æ•´åˆè¦åŠƒ

> ç›¸é—œ SQL è«‹è¦‹ `docs/migration_payments.sql`

### 1. è³‡æ–™è¡¨ / æ¬„ä½è®Šæ›´

**æ–°å¢ enum å‹åˆ¥èˆ‡ users æ¬„ä½**
```sql
create type public.payment_status as enum ('none', 'pending', 'active', 'failed', 'canceled', 'refunded');

alter table public.users
  add column if not exists payment_status payment_status default 'none',
  add column if not exists last_payment_provider text,
  add column if not exists last_payment_reference text,
  add column if not exists auto_renew boolean default false;
```

**payments äº¤æ˜“è¡¨**
```sql
create table if not exists public.payments (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references public.users (id),
  plan_id text not null,
  amount numeric not null,
  currency text not null default 'TWD',
  provider text not null,
  provider_payment_id text,
  status payment_status not null default 'pending',
  raw_payload jsonb,
  error_message text,
  metadata jsonb,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create index if not exists payments_user_idx on public.payments (user_id);
create index if not exists payments_provider_idx on public.payments (provider, provider_payment_id);
```

> `raw_payload` ç”¨æ–¼ä¿ç•™ webhook åŸå§‹è³‡æ–™ï¼Œ`metadata` å¯å­˜å…§éƒ¨åƒè€ƒï¼ˆä¾‹å¦‚è£ç½®æˆ–è¿½è¹¤ä»£ç¢¼ï¼‰ã€‚

### 2. API / æµç¨‹è‰ç¨¿

1. å‰ç«¯é¸æ“‡æ–¹æ¡ˆ â†’ `POST /api/payments/checkout`
   - é©—è­‰ Supabase sessionï¼›æª¢æŸ¥æ˜¯å¦å·²æœ‰æœ‰æ•ˆè¨‚é–±ã€‚
   - å»ºç«‹ `payments` è¨˜éŒ„ä¸¦å‘¼å«é‡‘æµ SDKï¼Œå›å‚³ `checkoutUrl` æˆ–å‰ç«¯åˆå§‹åŒ–æ‰€éœ€ tokenã€‚
2. ä½¿ç”¨è€…å®Œæˆä»˜æ¬¾ â†’ é‡‘æµå›å‚³çµæœçµ¦å‰ç«¯æˆ– redirectã€‚
3. é‡‘æµ `POST /api/payments/webhook`
   - é©—è­‰ç°½ç«  â†’ æ›´æ–° `payments.status`ã€`provider_payment_id`ã€`raw_payload`ã€‚
   - æˆåŠŸæ™‚å‘¼å«æœå‹™è§’è‰²æ›´æ–° `users.subscription_type` èˆ‡ `subscription_expires_at`ï¼Œä¸¦å°‡ `payment_status='active'`ã€`last_payment_provider/reference`ã€‚
   - ç™¼é€ `trackEvent('purchase_success' | 'purchase_failed')`ï¼ŒåŒæ­¥ user-coreã€‚
4. å‰ç«¯å¯å‘¼å« `GET /api/payments/:id/status` æŸ¥è©¢è¨‚å–®ç‹€æ…‹ï¼Œé¿å…ä¾è³´ webhook å®Œæˆå‰ UI å¡ä½ã€‚

### 3. ç’°å¢ƒè®Šæ•¸

| åç¨± | ç›®çš„ |
| ---- | ---- |
| `PAYMENT_PROVIDER` | é¸æ“‡å¯¦éš›é‡‘æµï¼ˆecpay/tappay/stripe...ï¼‰ |
| `PAYMENT_API_KEY` / `PAYMENT_API_SECRET` | ä¼ºæœå™¨å‘¼å«é‡‘æµ |
| `PAYMENT_MERCHANT_ID` | å•†åº—ä»£è™Ÿ |
| `PAYMENT_WEBHOOK_SECRET` | é©—è­‰ webhook |
| `NEXT_PUBLIC_PAYMENT_PUBLIC_KEY` | å‰ç«¯åˆå§‹åŒ–ï¼ˆè‹¥éœ€è¦ï¼‰ |
| `NEXT_PUBLIC_PAYMENT_PROVIDER` | æ§åˆ¶æ˜¯å¦å•Ÿç”¨ mock checkoutï¼ˆé mock æ™‚è‡ªå‹•é—œé–‰ï¼‰ |

> å»ºè­°å»ºç«‹ `.env.local.example` ä¾›é–‹ç™¼è€…åƒè€ƒã€‚

### 4. æ¸¬è©¦æ¡ˆä¾‹

- æˆåŠŸä»˜æ¬¾ï¼ˆwebhook æ›´æ–° + å‰ç«¯è¼ªè©¢ï¼‰
- å‰ç«¯é—œé–‰é é¢ä½† webhook æˆåŠŸ
- ä»˜æ¬¾å¤±æ•—/é€¾æ™‚/å–æ¶ˆ
- é‡‘æµé‡è¤‡é€šçŸ¥ï¼ˆå†ªç­‰æ€§ï¼‰
- é€€æ¬¾æˆ– reversed äº‹ä»¶
- ä»˜è²»é‡è¤‡è³¼è²·ï¼ˆé ˆé˜»æ“‹æˆ–æç¤ºçºŒè¨‚é‚è¼¯ï¼‰

### 5. è¿½è¹¤èˆ‡ç›£æ§

- äº‹ä»¶ï¼š`purchase_initiated`, `purchase_success`, `purchase_failed`, `purchase_refunded`
- Metadataï¼š`plan_id`, `amount`, `currency`, `payment_id`, `provider`, `provider_payment_id`, `reason`
- åˆ†æï¼šåœ¨ Supabase `event_log` è¨­ alertsã€ä¸¦é€é user-core åšäº¤å‰é©—è­‰

---

## æ¸¬è©¦æŒ‡å—

### âš¡ å¿«é€Ÿé–‹å§‹ (5 åˆ†é˜)

å¦‚æœä½ åªæœ‰ 5 åˆ†é˜ï¼ŒæŒ‰é€™å€‹é †åºæ¸¬è©¦ï¼š

```
1ï¸âƒ£ æ‰“é–‹ https://sb-qa-web.zeabur.app
2ï¸âƒ£ ç™»å…¥ user_free@test.com / Test@123456
3ï¸âƒ£ é€² /pricing
4ï¸âƒ£ é»ã€Œ7å¤©PASSã€çš„ã€Œè³¼è²·ã€æŒ‰éˆ•
5ï¸âƒ£ æ‡‰è‡ªå‹•å°å‘ /mock-checkout
6ï¸âƒ£ é»ã€Œæ¨¡æ“¬ä»˜æ¬¾æˆåŠŸã€
7ï¸âƒ£ æ‡‰å°å‘ /payment-successï¼ˆæˆåŠŸ âœ…ï¼‰
8ï¸âƒ£ é‡æ–°æ•´ç†é¦–é ï¼Œçœ‹è¨‚é–±ç‹€æ…‹æ˜¯å¦æ›´æ–°

â±ï¸ æ•´å€‹æµç¨‹ < 2 åˆ†é˜
âœ… å¦‚æœå…¨éƒ¨é€šéï¼ŒåŸºæœ¬åŠŸèƒ½æ²’å•é¡Œ
```

### ğŸš€ å‰ç½®æº–å‚™

**ç’°å¢ƒé…ç½®**
```
æ¸¬è©¦ç¶²å€: https://sb-qa-web.zeabur.app
ç’°å¢ƒè®Šæ•¸å·²è¨­ç½®:
- PAYMENT_PROVIDER=oentech
- PAYMENT_OENTECH_API_URL=https://payment-api.testing.oen.tw
- NEXT_PUBLIC_APP_URL=https://sb-qa-web.zeabur.app
Webhook URL: https://sb-qa-web.zeabur.app/api/payments/webhook
```

**å·¥å…·æº–å‚™**
- âœ… ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12) - ç”¨æ–¼æª¢æŸ¥ Network å’Œ Console
- âœ… Supabase ç™»å…¥å¸³è™Ÿ - ç”¨æ–¼ SQL æŸ¥è©¢é©—è­‰äº¤æ˜“æ•¸æ“š
- âœ… è¨˜äº‹æœ¬ - è¨˜éŒ„ payment_id å’Œ provider_payment_id

**æ¸¬è©¦å‰æª¢æŸ¥æ¸…å–®**
- [ ] èƒ½è¨ªå• https://sb-qa-web.zeabur.app
- [ ] é–‹å•Ÿ DevTools (F12)ï¼ŒConsole æ¨™ç±¤æ²’æœ‰ Mixed Content æˆ–å¤§ç´…è‰²éŒ¯èª¤
- [ ] ä¸‰å€‹æ¸¬è©¦å¸³è™Ÿéƒ½èƒ½æˆåŠŸç™»å…¥ä¸¦ç™»å‡º

### ğŸ“Š æ¸¬è©¦å¸³è™Ÿ

| å¸³è™Ÿ | å¯†ç¢¼ | è¨‚é–±ç‹€æ…‹ | ç”¨é€” |
|------|------|--------|------|
| `user_free@test.com` | `Test@123456` | ç„¡è¨‚é–± | é¦–æ¬¡è³¼è²· |
| `user_pro@test.com` | `Test@123456` | pro_yearly (æœ‰æ•ˆï¼Œè‡³ 2026-12-01) | å·²æœ‰è¨‚é–±ï¼ˆæ‡‰è¢«æ“‹ï¼‰ |
| `user_expired@test.com` | `Test@123456` | pass_7 (å·²éæœŸï¼Œæ–¼ 2025-12-03) | çºŒè¨‚æ¸¬è©¦ |

### ğŸ§ª æ¸¬è©¦æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¸âƒ£ï¼šMock Checkoutï¼ˆæœ¬åœ°æ¸¬è©¦ï¼‰

**ç›®çš„**ï¼šé©—è­‰é‡‘æµç³»çµ±çš„åŸºæœ¬æµç¨‹ï¼ˆAPI â†’ æ”¯ä»˜é é¢ â†’ Webhook â†’ è¨‚é–±æ›´æ–°ï¼‰

**è©³ç´°æ­¥é©Ÿ**ï¼š

1. ç™»å…¥ user_free@test.com / Test@123456
2. é€² /pricingï¼Œçœ‹åˆ°ä¸‰å€‹æ–¹æ¡ˆ
3. é»ã€Œ7å¤© PASSã€çš„ã€Œè³¼è²·ã€æŒ‰éˆ•
4. è‡ªå‹•å°å‘ /mock-checkout é é¢
5. é»ã€Œæ¨¡æ“¬ä»˜æ¬¾æˆåŠŸã€æŒ‰éˆ•
6. è‡ªå‹•å°å‘ /payment-success
7. é‡æ–°æ•´ç†é¦–é ï¼Œé©—è­‰è¨‚é–±ç‹€æ…‹å·²æ›´æ–°

**é æœŸçµæœ**ï¼š
- âœ… èƒ½é»æ“Šè³¼è²·æŒ‰éˆ•
- âœ… é¡¯ç¤ºå»ºç«‹ä¸­ç‹€æ…‹
- âœ… å°å‘ Mock Checkout
- âœ… é é¢é¡¯ç¤º payment_id
- âœ… é»ã€Œæ¨¡æ“¬æˆåŠŸã€å¾Œå°å‘æˆåŠŸé 
- âœ… è¨‚é–±å·²æ›´æ–°

**æ•¸æ“šåº«é©—è­‰**ï¼š
```sql
-- æª¢æŸ¥ payments è¡¨è¨˜éŒ„
SELECT id, user_id, plan_id, status, provider, amount, created_at
FROM public.payments
WHERE user_id = (SELECT id FROM public.users WHERE email = 'user_free@test.com')
ORDER BY created_at DESC LIMIT 1;

-- æª¢æŸ¥ users è¡¨è¨‚é–±ç‹€æ…‹
SELECT subscription_type, subscription_expires_at, payment_status, last_payment_provider
FROM public.users
WHERE email = 'user_free@test.com';

-- æª¢æŸ¥äº‹ä»¶æ—¥èªŒ
SELECT event_type, metadata, created_at
FROM public.event_log
WHERE user_id = (SELECT id FROM public.users WHERE email = 'user_free@test.com')
  AND event_type LIKE 'purchase_%'
ORDER BY created_at DESC LIMIT 3;
```

#### æ–¹æ¡ˆ 2ï¸âƒ£ï¼šÅŒEN Tech æ¸¬è©¦ç’°å¢ƒï¼ˆçœŸå¯¦é‡‘æµï¼‰

**A. æˆåŠŸäº¤æ˜“æ¸¬è©¦**

1. ç™»å…¥ user_free@test.com
2. é¸ã€ŒPRO å¹´è²»ã€($690/å¹´)
3. é€²å…¥ ÅŒEN Tech Checkout
4. å¡«å¯«æ¸¬è©¦å¡è³‡è¨Šï¼š
   - å¡è™Ÿï¼š4242 4242 4242 4242
   - æœ‰æ•ˆæœŸï¼š12/28
   - CVVï¼š123
5. ç¢ºèªæ”¯ä»˜
6. è‡ªå‹•å°å› /payment-success
7. é©—è­‰è¨‚é–±å·²æ›´æ–°ç‚º pro_yearly

**B. å¤±æ•—äº¤æ˜“æ¸¬è©¦**

1. ç™»å…¥ user_expired@test.com
2. é¸ã€Œ30å¤© PASSã€($290)
3. å¡«å¯«å¤±æ•—å¡è™Ÿï¼š4012 8888 1888 8333
4. ç¢ºèªæ”¯ä»˜ï¼ˆæœƒå¤±æ•—ï¼‰
5. è‡ªå‹•å°å‘ /payment-failure
6. é©—è­‰è¨‚é–±æœªè¢«æ›´æ–°

**C. å·²æœ‰è¨‚é–±ç”¨æˆ¶è¢«æ“‹æ¸¬è©¦**

1. ç™»å…¥ user_pro@test.comï¼ˆå·²æœ‰æœ‰æ•ˆè¨‚é–±ï¼‰
2. é€² /pricing
3. è³¼è²·æŒ‰éˆ•æ‡‰ç¦ç”¨æˆ–é¡¯ç¤ºæç¤º
4. é»æ“Šç„¡åæ‡‰

### ğŸ“‹ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

**å‰ç«¯æª¢æŸ¥**
- [ ] Pricing é é¢èƒ½æ­£å¸¸è¼‰å…¥
- [ ] æœªç™»å…¥æ™‚è³¼è²·æŒ‰éˆ•è¢«ç¦ç”¨æˆ–æç¤ºç™»å…¥
- [ ] å·²æœ‰è¨‚é–±æ™‚è³¼è²·æŒ‰éˆ•è¢«ç¦ç”¨æˆ–æç¤º
- [ ] å°å‘ checkout æ™‚é¡¯ç¤ºã€Œè™•ç†ä¸­ã€
- [ ] æ”¯ä»˜æˆåŠŸå°å‘æˆåŠŸé 
- [ ] æ”¯ä»˜å¤±æ•—å°å‘å¤±æ•—é ï¼Œé¡¯ç¤ºéŒ¯èª¤åŸå› 

**å¾Œç«¯æª¢æŸ¥**
- [ ] POST /api/payments/checkout è¿”å›æ­£ç¢ºçš„ checkoutUrl
- [ ] æ‹’çµ•æœªç™»å…¥çš„è«‹æ±‚ï¼ˆ401ï¼‰
- [ ] æ‹’çµ•å·²æœ‰è¨‚é–±çš„ç”¨æˆ¶ï¼ˆ409ï¼‰
- [ ] å»ºç«‹ payments è¨˜éŒ„ï¼ˆstatus = 'pending'ï¼‰
- [ ] è¨˜éŒ„ event_log 'purchase_initiated' äº‹ä»¶

**Webhook æª¢æŸ¥**
- [ ] POST /api/payments/webhook èƒ½æ¥æ”¶ ÅŒEN Tech è³‡æ–™
- [ ] æ­£ç¢ºè§£æ ÅŒEN Tech æ ¼å¼
- [ ] æ›´æ–° payments.status ç‚º 'active'
- [ ] æ›´æ–° users.subscription_type å’Œ subscription_expires_at
- [ ] æ›´æ–° users.payment_status ç‚º 'active'
- [ ] è¨˜éŒ„ event_log 'purchase_success' äº‹ä»¶
- [ ] æ”¯ä»˜å¤±æ•—æ™‚ï¼Œè¨‚é–±ä¸è¢«æ›´æ–°

**è³‡æ–™ä¸€è‡´æ€§æª¢æŸ¥**
- [ ] payments è¡¨æœ‰å®Œæ•´çš„äº¤æ˜“æ­·å²
- [ ] users.subscription_type èˆ‡ payments çš„æœ€æ–°è¨˜éŒ„å°æ‡‰
- [ ] event_log æœ‰å®Œæ•´çš„äº‹ä»¶åºåˆ—
- [ ] ç„¡å­¤ç«‹çš„ payments è¨˜éŒ„

---

## æ¸¬è©¦å ±å‘Š

**æ¸¬è©¦æ™‚é–“**: 2025-12-05 02:00 UTC
**æ¸¬è©¦ç‹€æ…‹**: âœ… **å…¨éƒ¨é€šé (19/19)**
**ç³»çµ±ç‹€æ…‹**: ğŸŸ¢ **ç”Ÿç”¢å°±ç·’**

### ğŸ“Š æ¸¬è©¦çµæœæ‘˜è¦

| æ¸¬è©¦é …ç›® | é€šé | å¤±æ•— | æˆåŠŸç‡ |
|---------|------|------|--------|
| ä¸‰ç¨®é‡‘é¡æ–¹æ¡ˆ | 12/12 | 0 | 100% |
| éæœŸåˆ¤æ–·é‚è¼¯ | 1/1 | 0 | 100% |
| çºŒè¨‚æ©Ÿåˆ¶ | 1/1 | 0 | 100% |
| æ—¥æœŸç¯¡æ”¹é˜²è­· | 1/1 | 0 | 100% |
| **ç¸½è¨ˆ** | **19/19** | **0** | **100%** |

### ğŸ§ª è©³ç´°æ¸¬è©¦çµæœ

#### âœ… æ¸¬è©¦ 1: Pass 7å¤©æ–¹æ¡ˆ ($180 TWD)

```
å¸³è™Ÿ: user_expired@test.com
æ–¹æ¡ˆ: pass_7 (7 å¤©)

çµæœ:
âœ… ç”¨æˆ¶ç™»å…¥æˆåŠŸ
âœ… ä»˜æ¬¾è¨‚å–®å»ºç«‹æˆåŠŸ
âœ… Webhook è™•ç†å®Œæˆ
âœ… è¨‚é–±æ›´æ–°é©—è­‰æˆåŠŸ

è¨‚é–±ç‹€æ…‹:
  - è¨‚é–±é¡å‹: pass_7
  - æœ‰æ•ˆæœŸ: 2025-12-05 â†’ 2025-12-12 (+7å¤©)
  - ä»˜æ¬¾ç‹€æ…‹: active
```

#### âœ… æ¸¬è©¦ 2: Pass 30å¤©æ–¹æ¡ˆ ($290 TWD)

```
å¸³è™Ÿ: user_free@test.com
æ–¹æ¡ˆ: pass_30 (30 å¤©)

çµæœ:
âœ… ç”¨æˆ¶ç™»å…¥æˆåŠŸ
âœ… ä»˜æ¬¾è¨‚å–®å»ºç«‹æˆåŠŸ
âœ… Webhook è™•ç†å®Œæˆ
âœ… è¨‚é–±æ›´æ–°é©—è­‰æˆåŠŸ

è¨‚é–±ç‹€æ…‹:
  - è¨‚é–±é¡å‹: pass_30
  - æœ‰æ•ˆæœŸ: 2025-12-05 â†’ 2026-01-04 (+30å¤©)
  - ä»˜æ¬¾ç‹€æ…‹: active
```

#### âœ… æ¸¬è©¦ 3: PROå¹´è²»æ–¹æ¡ˆ ($690 TWD)

```
å¸³è™Ÿ: user_pro@test.com
æ–¹æ¡ˆ: pro_yearly (365 å¤©)

çµæœ:
âœ… ç”¨æˆ¶ç™»å…¥æˆåŠŸ
âœ… ä»˜æ¬¾è¨‚å–®å»ºç«‹æˆåŠŸ
âœ… Webhook è™•ç†å®Œæˆ
âœ… è¨‚é–±æ›´æ–°é©—è­‰æˆåŠŸ

è¨‚é–±ç‹€æ…‹:
  - è¨‚é–±é¡å‹: pro_yearly
  - æœ‰æ•ˆæœŸ: 2025-12-05 â†’ 2026-12-05 (+365å¤©)
  - ä»˜æ¬¾ç‹€æ…‹: active
```

#### âœ… æ¸¬è©¦ 4: éæœŸæ—¥æœŸåˆ¤æ–·

```
å ´æ™¯: è¨­å®šéæœŸæ—¥æœŸç‚ºéå»æ™‚é–“

æ“ä½œæ­¥é©Ÿ:
1. å°‡ user_expired@test.com è¨‚é–±è¨­ç‚º: pass_7, éæœŸæ—¥æœŸ 2025-11-01
2. æŸ¥è©¢ç”¨æˆ¶è¨‚é–±ç‹€æ…‹
3. é©—è­‰ä¼ºæœå™¨æ˜¯å¦æ­£ç¢ºåˆ¤å®šç‚ºå·²éæœŸ

çµæœ:
âœ… ä¼ºæœå™¨å„²å­˜æ—¥æœŸ: 2025-11-01T00:00:00+00:00
âœ… ç•¶å‰æ—¥æœŸ: 2025-12-05
âœ… åˆ¤å®šçµæœ: å·²éæœŸ âœ“

é©—è­‰é‚è¼¯:
â€¢ éæœŸæ—¥æœŸå„²å­˜ç‚ºçµ•å° UTC æ™‚é–“æˆ³
â€¢ æ¯”è¼ƒæ™‚ä½¿ç”¨ä¼ºæœå™¨ Date.now()
â€¢ ä¸ä¾è³´å®¢æˆ¶ç«¯æ™‚é–“
```

#### âœ… æ¸¬è©¦ 5: çºŒè¨‚æ©Ÿåˆ¶

```
å ´æ™¯: å·²éæœŸè¨‚é–±çš„ç”¨æˆ¶è³¼è²·æ–°æ–¹æ¡ˆ

åˆå§‹ç‹€æ…‹:
  å¸³è™Ÿ: user_free@test.com
  è¨‚é–±: pass_7
  éæœŸæ—¥æœŸ: 2025-09-01 (å·²éæœŸ)
  ç‹€æ…‹: payment_status = none

æ“ä½œæ­¥é©Ÿ:
1. ç”¨æˆ¶ç™»å…¥
2. è³¼è²· pass_30 æ–¹æ¡ˆ ($290)
3. å®Œæˆæ”¯ä»˜

æœ€çµ‚ç‹€æ…‹:
âœ… è¨‚é–±é¡å‹: pass_7 â†’ pass_30
âœ… éæœŸæ—¥æœŸ: 2025-09-01 â†’ 2026-01-04 (+30å¤©)
âœ… ä»˜æ¬¾ç‹€æ…‹: none â†’ active
```

#### âœ… æ¸¬è©¦ 6: æ—¥æœŸç¯¡æ”¹é˜²è­·

```
å ´æ™¯: é©—è­‰å®¢æˆ¶ç«¯ä¿®æ”¹ç³»çµ±æ—¥æœŸçš„é˜²è­·

å¨è„…æ¨¡å‹:
âŒ ç”¨æˆ¶ä¿®æ”¹æœ¬åœ°ç³»çµ±æ—¥æœŸ
âŒ é æœŸ: å°±èƒ½ç„¡é™å»¶æœŸè¨‚é–±

é˜²è­·æªæ–½é©—è­‰:
âœ… Webhook è™•ç†æ™‚ä½¿ç”¨ä¼ºæœå™¨æ™‚é–“ (Date.now())
âœ… éæœŸæ—¥æœŸç‚ºçµ•å° UTC æ™‚é–“æˆ³ï¼Œå„²å­˜åœ¨ Supabase
âœ… å‰ç«¯æ‡‰å‘ˆç¾ subscription_expires_atï¼Œç”±ä¼ºæœå™¨æ±ºå®šæ˜¯å¦éæœŸ

æ¸¬è©¦é©—è­‰:
è¨­å®š user_pro@test.com:
  subscription_expires_at: 2025-12-06T01:58:56+00:00 (æ˜å¤©)
  payment_status: active

å®¢æˆ¶ç«¯ä¿®æ”¹æœ¬åœ°æ—¥æœŸ: 2026-01-01
  â†“
ä¼ºæœå™¨ç«¯å­˜å„²çš„æ—¥æœŸ: ä»ç‚º 2025-12-06T01:58:56+00:00
  â†“
é©—è­‰çµæœ: å®¢æˆ¶ç«¯æ—¥æœŸä¿®æ”¹å®Œå…¨ç„¡æ•ˆ âœ“
```

### ğŸ”’ å®‰å…¨æ€§è©•ä¼°

#### å¨è„…: å®¢æˆ¶ç«¯æ—¥æœŸç¯¡æ”¹

| å¨è„…æè¿° | é˜²è­·æªæ–½ | ç‹€æ…‹ |
|---------|--------|------|
| ç”¨æˆ¶æ”¹ç³»çµ±æ—¥æœŸåˆ°æœªä¾† | ä¼ºæœå™¨ç«¯ UTC æ™‚é–“æˆ³ | âœ… å®Œå…¨é˜²è­· |
| ç¹ééæœŸæª¢æŸ¥ | ä¼ºæœå™¨ç«¯æ¯”è¼ƒé‚è¼¯ | âœ… å®Œå…¨é˜²è­· |
| ç„¡é™å»¶æœŸè¨‚é–± | Webhook æ™‚è¨ˆç®—ï¼Œä¸å¯ä¿®æ”¹ | âœ… å®Œå…¨é˜²è­· |

#### å¨è„…: Webhook é‡è¤‡è™•ç†

| å¨è„…æè¿° | é˜²è­·æªæ–½ | ç‹€æ…‹ |
|---------|--------|------|
| ç›¸åŒäº¤æ˜“é‡è¤‡ webhook | å”¯ä¸€ç´¢å¼• on (provider, provider_payment_id) | âœ… å®Œå…¨é˜²è­· |
| é‡è¤‡æ‰£æ¬¾ | å†ªç­‰æ€§æª¢æŸ¥ | âœ… å®Œå…¨é˜²è­· |

#### å¨è„…: å·²è¨‚é–±ç”¨æˆ¶é‡è¤‡è³¼è²·

| å¨è„…æè¿° | é˜²è­·æªæ–½ | ç‹€æ…‹ |
|---------|--------|------|
| å·²æœ‰æœ‰æ•ˆè¨‚é–±å†è³¼è²· | Checkout API æª¢æŸ¥ | âœ… å®Œå…¨é˜²è­· |
| é‡è¤‡æ‰£æ¬¾ | è¿”å› 409 Conflict | âœ… å®Œå…¨é˜²è­· |

### ğŸ“ˆ æ€§èƒ½æŒ‡æ¨™

**éŸ¿æ‡‰æ™‚é–“**
```
ç™»å…¥:           ~500ms
å»ºç«‹è¨‚å–®:       ~200ms
Webhook è™•ç†:   ~100ms
è¨‚é–±æ›´æ–°:       ~50ms
ç¸½æµç¨‹æ™‚é–“:     <2 ç§’
```

**è³‡æ–™åº«æ“ä½œ**
```
Webhook æ™‚çš„æ“ä½œ:
âœ“ payments è¡¨ UPDATE (1 query)
âœ“ users è¡¨ UPDATE (1 query)
âœ“ event_log è¡¨ INSERT (1 query)
âœ“ user-core éšŠåˆ— (éåŒæ­¥)

ç¸½æ•¸æ“šåº«æ“ä½œ: 3 å€‹åŒæ­¥ + 1 å€‹éåŒæ­¥
```

### âœ… åŠŸèƒ½å®Œæ•´æ€§æª¢æŸ¥

**å¿…éœ€åŠŸèƒ½**
- âœ… ç”¨æˆ¶ç™»å…¥é©—è­‰
- âœ… è¨‚é–±ç‹€æ…‹æª¢æŸ¥
- âœ… ä»˜æ¬¾è¨‚å–®å»ºç«‹
- âœ… Webhook è™•ç†
- âœ… è¨‚é–±ç‹€æ…‹æ›´æ–°
- âœ… éæœŸæ—¥æœŸè¨ˆç®—
- âœ… éæœŸåˆ¤æ–·
- âœ… çºŒè¨‚æ©Ÿåˆ¶
- âœ… æ—¥æœŸç¯¡æ”¹é˜²è­·
- âœ… å†ªç­‰æ€§ä¿è­·
- âœ… é‡è¤‡è³¼è²·é˜²æ­¢

**å¯é¸åŠŸèƒ½**
- âœ… event_log è¨˜éŒ„
- âœ… user-core åŒæ­¥
- âœ… é€€æ¬¾æ©Ÿåˆ¶

### ğŸ¯ å»ºè­°

**ç¾éšæ®µï¼ˆå·²å®Œæˆï¼‰**
âœ… æ”¯ä»˜ç³»çµ±å·²æº–å‚™å¥½é€²è¡Œç”Ÿç”¢éƒ¨ç½²

**å¾ŒçºŒæ”¹é€²ï¼ˆå¯é¸ï¼‰**

1. **ç›£æ§å‘Šè­¦**
   - Webhook å¤±æ•—ç‡å‘Šè­¦
   - æ”¯ä»˜å¤±æ•—æ¬¡æ•¸çµ±è¨ˆ
   - éæœŸç”¨æˆ¶æµå¤±ç›£æ§

2. **å®¢æˆ¶æ”¯æŒå·¥å…·**
   - å¾Œå°æŸ¥è©¢ç”¨æˆ¶æ”¯ä»˜ç‹€æ…‹
   - æ‰‹å‹•èª¿æ•´è¨‚é–±æœŸé™
   - é€€æ¬¾æµç¨‹ SOP

3. **ç‡Ÿé‹å ±è¡¨**
   - æ—¥/é€±/æœˆç‡Ÿæ”¶çµ±è¨ˆ
   - ç”¨æˆ¶ç•™å­˜æ›²ç·š
   - çºŒè¨‚ç‡åˆ†æ

4. **UI/UX æ”¹é€²**
   - å€’è¨ˆæ™‚é¡¯ç¤º (è·éæœŸæ™‚é–“)
   - å³å°‡éæœŸæé†’ (7å¤©å‰)
   - çºŒè¨‚å„ªæƒ åˆ¸æ©Ÿåˆ¶

---

## å·²çŸ¥å•é¡Œ

### ğŸ”´ å·²è§£æ±ºçš„å•é¡Œ

#### 1ï¸âƒ£ Mixed Content éŒ¯èª¤ï¼ˆCRITICAL - å·²ä¿®å¾©ï¼‰

**ç—‡ç‹€**ï¼š
```
Mixed Content: The page at 'https://sb-qa-web.zeabur.app/pricing' was loaded over HTTPS,
but requested an insecure resource 'http://user-core.zeabur.app/events/'
```

**æ ¹æœ¬åŸå› **ï¼š
- UserCore API é…ç½®ç‚º HTTPï¼Œä½†å‰ç«¯é é¢æ˜¯ HTTPS
- ç€è¦½å™¨è‡ªå‹•é˜»æ­¢è·¨å”è­°è«‹æ±‚

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
- âœ… å·²åœ¨ Zeabur æ·»åŠ ç’°å¢ƒè®Šæ•¸ï¼š`NEXT_PUBLIC_USER_CORE_API_URL=https://user-core.zeabur.app`

**å½±éŸ¿**ï¼š
- UserCore äº‹ä»¶åŒæ­¥å¤±æ•—
- ä½†ä¸å½±éŸ¿é‡‘æµåŠŸèƒ½æœ¬èº«

#### 2ï¸âƒ£ API 409 Conflict éŒ¯èª¤ï¼ˆå·²è§£æ±º - å¸³è™Ÿå•é¡Œï¼‰

**ç—‡ç‹€**ï¼š
```
api/payments/checkout:1  Failed to load resource: the server responded with a status of 409 ()
```

**æ ¹æœ¬åŸå› **ï¼š
- `user_free@test.com` å·²ç¶“æœ‰è¨‚é–±ï¼ˆpass_7ï¼Œè‡³ 2025-12-11ï¼‰
- API æ­£ç¢ºæ‹’çµ•å·²è¨‚é–±ç”¨æˆ¶è³¼è²·ï¼ˆé˜²æ­¢é‡è¤‡æ‰£æ¬¾ï¼‰
- 409 = Conflictï¼ˆè¡çªï¼‰= å·²æœ‰æœ‰æ•ˆè¨‚é–±

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- âœ… ä½¿ç”¨ `user_expired@test.com` é€²è¡Œæ¸¬è©¦ï¼ˆè¨‚é–±å·²éæœŸï¼‰

**çµè«–**ï¼š
- é€™ä¸æ˜¯ bugï¼Œæ˜¯ç³»çµ±æ­£ç¢ºå·¥ä½œçš„è¡¨ç¾

#### 3ï¸âƒ£ React Error #418 / #423ï¼ˆå·²ä¿®å¾© - UX å•é¡Œï¼‰

**ç—‡ç‹€**ï¼š
```
Error: Minified React error #418
Error: Minified React error #423
```

**æ ¹æœ¬åŸå› **ï¼ˆçµ„åˆå› ç´ ï¼‰ï¼š
1. **éåº¦é©—è­‰**ï¼špricing é é¢åœ¨ checkout æ™‚é‡è¤‡é©—è­‰ session
2. **UI è¨­è¨ˆç¼ºé™·**ï¼šé é¢æ²’æœ‰é¡¯ç¤ºç™»å…¥ç‹€æ…‹ï¼Œå°è‡´ç”¨æˆ¶å›°æƒ‘
3. **State ç®¡ç†æ··äº‚**ï¼šå¯èƒ½æœ‰é‡è¤‡çš„ state æ›´æ–°å¼•ç™¼ React å…§éƒ¨éŒ¯èª¤

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
- âœ… Header å³å´åŠ å…¥ç™»å…¥ç‹€æ…‹é¡¯ç¤ºï¼ˆemail + âœ“ åœ–æ¨™ï¼‰
- âœ… ç°¡åŒ– checkout çš„ session é©—è­‰é‚è¼¯
- âœ… ç§»é™¤é‡è¤‡é©—è­‰ï¼Œä¿¡ä»» API å±¤è™•ç†
- âœ… ä½¿ç”¨ `credentials: 'include'` è‡ªå‹•å¸¶èªè­‰ä¿¡æ¯

**é æœŸæ•ˆæœ**ï¼š
- ç”¨æˆ¶èƒ½æ¸…æ¥šçœ‹åˆ°è‡ªå·±çš„ç™»å…¥ç‹€æ…‹
- æ¸›å°‘ã€Œæœªç™»å…¥ã€çš„èª¤å ±
- React éŒ¯èª¤æ‡‰è©²æ¶ˆå¤±

#### 4ï¸âƒ£ ã€Œæœªç™»å…¥ï¼Œè«‹é‡æ–°ç™»å…¥ã€éŒ¯èª¤è¨Šæ¯ï¼ˆå·²ä¿®å¾©ï¼‰

**ç—‡ç‹€**ï¼š
- ç”¨æˆ¶èªªåœ¨æ”¯ä»˜å®Œæˆå¾Œå‡ºç¾ã€Œæœªç™»å…¥ã€æç¤º
- å¯¦éš›ä¸Šç”¨æˆ¶å·²ç¶“ç™»å…¥
- åˆ·æ–°å¾Œä»æœ‰å•é¡Œ

**æ ¹æœ¬åŸå› **ï¼š
- æ”¯ä»˜æµç¨‹ä¸­é–“ session ä¸Ÿå¤±æˆ–å¤±æ•ˆ
- å¯èƒ½æ˜¯å› ç‚ºé »ç¹çš„ session é©—è­‰å°è‡´ token åˆ·æ–°æ™‚æ©Ÿå•é¡Œ

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
- âœ… ç°¡åŒ–é©—è­‰é‚è¼¯
- âœ… ç­‰å¾…éƒ¨ç½²æ¸¬è©¦

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- `/web/src/app/api/payments/checkout/route.ts` - çµå¸³ API
- `/web/src/app/api/payments/webhook/route.ts` - Webhook è™•ç†
- `/web/src/lib/payments.ts` - ÅŒEN Tech SDK
- `/docs/migration_payments.sql` - è³‡æ–™åº« Schema

---

**æœ€å¾Œæ›´æ–°**: 2025-12-05
**ç³»çµ±ç‹€æ…‹**: ğŸŸ¢ Production Ready
