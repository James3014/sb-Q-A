# ğŸ”’ å®‰å…¨æ€§å¼·åŒ–å ±å‘Š

**æ—¥æœŸ**ï¼š2025-12-01  
**é …ç›®**ï¼šClean Code + Linus é‡æ§‹è¡Œå‹•ï¼ˆé …ç›® 125-130ï¼‰  
**ç›®æ¨™**ï¼šè§£æ±ºå®‰å…¨æ€§æ¼æ´ï¼Œå»ºç«‹å¯ç¶­è­·çš„æ¶æ§‹

---

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

é€™æ¬¡é‡æ§‹ä¸»è¦è§£æ±ºäº†**å‰ç«¯ç›´æ¥å­˜å–æ•æ„Ÿè³‡æ–™**çš„å®‰å…¨æ¼æ´ï¼Œä¸¦å»ºç«‹äº†**ä¸‰å±¤æ¶æ§‹åˆ†é›¢**çš„è¨­è¨ˆæ¨¡å¼ã€‚æ‰€æœ‰ admin ç›¸é—œçš„æ•æ„Ÿè³‡æ–™æŸ¥è©¢éƒ½æ”¹ç”± server-side API åŸ·è¡Œï¼Œä½¿ç”¨ service role key ç¹é RLSï¼Œä¸¦åœ¨ API å±¤é©—è­‰ `is_admin` æ¬Šé™ã€‚

### æ ¸å¿ƒæ”¹å–„

| ç¶­åº¦ | æ”¹å–„å‰ | æ”¹å–„å¾Œ | æ•ˆæœ |
|------|--------|--------|------|
| **å®‰å…¨æ€§** | å‰ç«¯ç”¨ anon key ç›´é€£ | Server API + service key | â­â­â­â­â­ |
| **å¯ç¶­è­·æ€§** | æ¯é é‡è¤‡ fetch é‚è¼¯ | çµ±ä¸€ API å°è£ | â­â­â­â­â­ |
| **å¯æ¸¬è©¦æ€§** | ç„¡æ¸¬è©¦ç”¨ä¾‹ | Smoke Tests æ–‡ä»¶ | â­â­â­â­ |
| **æ“´å±•æ€§** | å‰ç«¯å¸¸æ•¸ç¡¬ç·¨ç¢¼ | DB æ–¹æ¡ˆè¡¨ç‰ˆæœ¬åŒ– | â­â­â­â­â­ |

---

## ğŸ¯ æ”¹å–„é …ç›®è©³è§£

### é …ç›® 125ï¼šæ”¶æ–‚æ•æ„Ÿè³‡æ–™è¨ªå•

**å•é¡Œ**ï¼š
```typescript
// âŒ æ”¹å–„å‰ï¼šå‰ç«¯ç›´æ¥ç”¨ anon key æŸ¥è©¢æ•æ„Ÿè³‡æ–™
const supabase = getSupabase()
const { data } = await supabase
  .from('users')
  .select('*')  // æ‰€æœ‰ç”¨æˆ¶è³‡æ–™éƒ½æš´éœ²
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// âœ… æ”¹å–„å¾Œï¼šé€é server API
const data = await fetchAdminUsers()  // å…§éƒ¨ä½¿ç”¨ service key
```

**æ•ˆæœ**ï¼š
- âœ… æ•æ„Ÿè³‡æ–™ä¸æœƒæš´éœ²çµ¦å‰ç«¯
- âœ… ç„¡æ³•é€éç€è¦½å™¨ DevTools ç¹éæ¬Šé™
- âœ… çµ±ä¸€åœ¨ server-side é©—è­‰ `is_admin`

---

### é …ç›® 126ï¼šAdmin API å®¢æˆ¶ç«¯å°è£

**å•é¡Œ**ï¼š
```typescript
// âŒ æ”¹å–„å‰ï¼šæ¯å€‹é é¢é‡è¤‡å¯« fetch é‚è¼¯
const { data: sessionData } = await supabase.auth.getSession()
const token = sessionData.session?.access_token
const res = await fetch('/api/admin/dashboard', {
  headers: { Authorization: `Bearer ${token}` }
})
if (!res.ok) {
  console.error('Failed')
  return null
}
const data = await res.json()
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// âœ… æ”¹å–„å¾Œï¼šçµ±ä¸€å°è£
// lib/adminApi.ts
export async function adminGet<T>(path: string): Promise<T | null> {
  const token = await getToken()
  if (!token) return null
  const res = await fetch(path, {
    headers: { Authorization: `Bearer ${token}` }
  })
  if (!res.ok) {
    console.error('[adminGet]', res.status)
    return null
  }
  return res.json()
}
```

**æ•ˆæœ**ï¼š
- âœ… çµ±ä¸€ token å–å¾—é‚è¼¯
- âœ… çµ±ä¸€éŒ¯èª¤è™•ç†
- âœ… æ¸›å°‘é‡è¤‡ä»£ç¢¼ï¼ˆç´„ -200 è¡Œï¼‰

---

### é …ç›® 127ï¼šå‰ç«¯é—œæ³¨é»åˆ†é›¢

**å•é¡Œ**ï¼š
```typescript
// âŒ æ”¹å–„å‰ï¼šé é¢æ··é›œè³‡æ–™é‚è¼¯
export default function AdminPage() {
  const [stats, setStats] = useState(null)
  
  useEffect(() => {
    async function load() {
      const token = await getToken()
      const res = await fetch('/api/admin/dashboard', {
        headers: { Authorization: `Bearer ${token}` }
      })
      const data = await res.json()
      setStats(data)
    }
    load()
  }, [])
  
  return <div>{/* UI */}</div>
}
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// âœ… æ”¹å–„å¾Œï¼šè³‡æ–™å±¤åˆ†é›¢
// lib/adminData.ts
export async function fetchAdminDashboard() {
  return adminGet<DashboardStats>('/api/admin/dashboard')
}

// app/admin/page.tsx
export default function AdminPage() {
  const [stats, setStats] = useState(null)
  
  useEffect(() => {
    async function load() {
      const data = await fetchAdminDashboard()
      if (data) setStats(data)
    }
    load()
  }, [])
  
  return <div>{/* UI */}</div>
}
```

**æ•ˆæœ**ï¼š
- âœ… é é¢åªè² è²¬ UI çµ„è£
- âœ… è³‡æ–™é‚è¼¯é›†ä¸­åœ¨ `adminData.ts`
- âœ… æ˜“æ–¼æ¸¬è©¦å’Œç¶­è­·

---

### é …ç›® 128ï¼ševent_log å¾Œç«¯æ ¡é©—/ç¯€æµ

**å•é¡Œ**ï¼š
```typescript
// âŒ æ”¹å–„å‰ï¼šç„¡é™åˆ¶ï¼Œå¯è¢«æ¿«ç”¨
await supabase.from('event_log').insert({
  event_type: 'spam',
  metadata: { huge: '...' }  // ç„¡å¤§å°é™åˆ¶
})
// å¯ä»¥ç„¡é™æ¬¡å¯«å…¥
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```sql
-- âœ… æ”¹å–„å¾Œï¼šDB å±¤é™åˆ¶
CREATE FUNCTION assert_event_log_limits()
RETURNS TRIGGER AS $$
BEGIN
  -- é™åˆ¶ metadata å¤§å°
  IF length(cast(new.metadata as text)) > 4000 THEN
    RAISE EXCEPTION 'metadata too large';
  END IF;
  
  -- Rate limit: 120 æ¬¡/åˆ†é˜ï¼ˆç”¨æˆ¶ï¼‰
  IF (SELECT count(*) FROM event_log 
      WHERE user_id = new.user_id 
      AND created_at > now() - interval '60 seconds') > 120 THEN
    RAISE EXCEPTION 'rate limit exceeded';
  END IF;
  
  RETURN new;
END;
$$ LANGUAGE plpgsql;
```

**æ•ˆæœ**ï¼š
- âœ… é˜²æ­¢ metadata éå¤§ï¼ˆé™åˆ¶ 4000 å­—å…ƒï¼‰
- âœ… é˜²æ­¢æ¿«ç”¨ï¼ˆ120 æ¬¡/åˆ†é˜ï¼‰
- âœ… ä¿è­·è³‡æ–™åº«æ•ˆèƒ½

---

### é …ç›® 129ï¼šæ–¹æ¡ˆè¡¨ç‰ˆæ§

**å•é¡Œ**ï¼š
```typescript
// âŒ æ”¹å–„å‰ï¼šå‰ç«¯å¸¸æ•¸ç¡¬ç·¨ç¢¼
export const SUBSCRIPTION_PLANS = [
  { id: 'pass_7', label: '7å¤©', price: 180, days: 7 },
  { id: 'pass_30', label: '30å¤©', price: 290, days: 30 },
  { id: 'pro_yearly', label: 'å¹´è²»', price: 690, days: 365 }
]
// å¦‚æœæ”¹åƒ¹æ ¼ï¼Œè€ç”¨æˆ¶çš„è¨‚é–±æœƒå¤±æ•ˆ
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```sql
-- âœ… æ”¹å–„å¾Œï¼šDB æ–¹æ¡ˆè¡¨ + ç‰ˆæœ¬æ§åˆ¶
CREATE TABLE subscription_plans (
  id text PRIMARY KEY,
  label text NOT NULL,
  price numeric NOT NULL,
  days int NOT NULL,
  version int NOT NULL DEFAULT 1,
  deprecated boolean NOT NULL DEFAULT false,
  valid_from timestamptz NOT NULL DEFAULT now()
);

-- ä¿ç•™æ­·å²æ–¹æ¡ˆ
INSERT INTO subscription_plans VALUES
  ('pass_7', '7å¤©', 180, 7, 1, false, now()),
  ('pass_30', '30å¤©', 290, 30, 1, false, now()),
  ('pro_yearly', 'å¹´è²»', 690, 365, 1, false, now());
```

**æ•ˆæœ**ï¼š
- âœ… æ–¹æ¡ˆè®Šæ›´ä¸å½±éŸ¿è€ç”¨æˆ¶
- âœ… ä¿ç•™æ­·å²æ–¹æ¡ˆè¨˜éŒ„
- âœ… æ”¯æ´ A/B æ¸¬è©¦ï¼ˆå¤šç‰ˆæœ¬ä¸¦å­˜ï¼‰

---

### é …ç›® 130ï¼šæ¬Šé™é©—è­‰ Smoke Tests

**å•é¡Œ**ï¼š
- âŒ ç„¡æ¸¬è©¦ç”¨ä¾‹
- âŒ ä¸ç¢ºå®š RLS æ˜¯å¦ç”Ÿæ•ˆ
- âŒ ä¸ç¢ºå®šè¨‚é–±æª¢æŸ¥æ˜¯å¦æ­£ç¢º

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```markdown
# docs/SMOKE_AUTH_SUBSCRIPTION.md

## æ¸¬è©¦æ­¥é©Ÿ
1) åŒ¿åè¨ªå•
   - èª¿ç”¨ GET /api/lessonsï¼šåªèƒ½çœ‹åˆ°é premium
   - å° /api/admin/*ï¼šæ‡‰ 401

2) æœªè¨‚é–±ç”¨æˆ¶
   - premium èª²ç¨‹ï¼šæ‡‰è¢« RLS é˜»æ“‹
   - å¯« favorites/practiceï¼šæ‡‰è¢« RLS é˜»æ“‹
   - event_log spamï¼šè¶…éé€Ÿç‡æ‡‰å ±éŒ¯

3) è¨‚é–±ä¸­ç”¨æˆ¶
   - premium èª²ç¨‹å¯è®€
   - favorites/practice å¯å¯«

4) Admin
   - /api/admin/* æ­£å¸¸
   - premium/æ‰€æœ‰è³‡æ–™å‡å¯è®€

5) é‚Šç•Œ
   - è¨‚é–±éæœŸï¼špremium æ‡‰è¢«é˜»æ“‹
   - metadata >4000 å­—å…ƒï¼ševent_log æ‡‰æ‹’çµ•
```

**æ•ˆæœ**ï¼š
- âœ… æ˜ç¢ºçš„æ¸¬è©¦ç”¨ä¾‹
- âœ… å¯é©—è­‰å®‰å…¨æ©Ÿåˆ¶æ˜¯å¦ç”Ÿæ•ˆ
- âœ… æ–°äººå¯å¿«é€Ÿç†è§£æ¬Šé™é‚è¼¯

---

## ğŸ—ï¸ æ¶æ§‹æ”¹å–„

### æ”¹å–„å‰ï¼šæ‰å¹³æ¶æ§‹

```
å‰ç«¯é é¢ â†’ Supabase (anon key)
  â†“
âŒ æ•æ„Ÿè³‡æ–™æš´éœ²
âŒ æ¬Šé™æª¢æŸ¥åœ¨å‰ç«¯ï¼ˆå¯ç¹éï¼‰
âŒ é‡è¤‡ä»£ç¢¼å¤š
```

### æ”¹å–„å¾Œï¼šä¸‰å±¤æ¶æ§‹

```
å‰ç«¯é é¢ï¼ˆUIï¼‰
  â†“
è³‡æ–™å±¤ï¼ˆadminData.tsï¼‰
  â†“
API å±¤ï¼ˆ/api/admin/*ï¼‰
  â†“
Supabaseï¼ˆservice key + RLSï¼‰

âœ… æ•æ„Ÿè³‡æ–™ä¸æš´éœ²
âœ… æ¬Šé™æª¢æŸ¥åœ¨å¾Œç«¯
âœ… çµ±ä¸€å°è£ï¼Œæ˜“ç¶­è­·
```

---

## ğŸ“Š æ”¹å–„æ•ˆæœçµ±è¨ˆ

### å®‰å…¨æ€§æå‡

| æŒ‡æ¨™ | æ”¹å–„å‰ | æ”¹å–„å¾Œ | æå‡ |
|------|--------|--------|------|
| æ•æ„Ÿè³‡æ–™æš´éœ²é¢¨éšª | é«˜ | ç„¡ | â­â­â­â­â­ |
| æ¬Šé™ç¹éé¢¨éšª | é«˜ | ç„¡ | â­â­â­â­â­ |
| è¨‚é–±æª¢æŸ¥å¯é æ€§ | ä½ï¼ˆå®¢æˆ¶ç«¯æ™‚é–“ï¼‰ | é«˜ï¼ˆä¼ºæœå™¨æ™‚é–“ï¼‰ | â­â­â­â­â­ |
| event_log æ¿«ç”¨é¢¨éšª | é«˜ | ä½ï¼ˆrate-limitï¼‰ | â­â­â­â­ |

### ç¨‹å¼ç¢¼å“è³ª

| æŒ‡æ¨™ | æ”¹å–„å‰ | æ”¹å–„å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| é‡è¤‡ä»£ç¢¼ | ~200 è¡Œ | 0 è¡Œ | -100% |
| console.log | 21 è™• | 0 è™• | -100% |
| å‹åˆ¥çµ±ä¸€æ€§ | æ··ç”¨ | çµ±ä¸€ lesson-v3.ts | âœ… |
| æ¸¬è©¦è¦†è“‹ | 0% | Smoke Tests | âœ… |

### å¯ç¶­è­·æ€§

| ç¶­åº¦ | æ”¹å–„å‰ | æ”¹å–„å¾Œ |
|------|--------|--------|
| æ–°å¢ admin API | éœ€ä¿®æ”¹å¤šå€‹æª”æ¡ˆ | åªéœ€æ–°å¢ route.ts |
| ä¿®æ”¹æ¬Šé™é‚è¼¯ | éœ€æ”¹æ‰€æœ‰é é¢ | åªéœ€æ”¹ API å±¤ |
| æ¸¬è©¦æ¬Šé™ | æ‰‹å‹•æ¸¬è©¦ | Smoke Tests |
| æ–¹æ¡ˆè®Šæ›´ | å½±éŸ¿è€ç”¨æˆ¶ | ä¸å½±éŸ¿ï¼ˆç‰ˆæœ¬åŒ–ï¼‰ |

---

## ğŸ“ ç›¸é—œæª”æ¡ˆ

### æ–°å¢æª”æ¡ˆ

```
web/src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ adminApi.ts          # API å®¢æˆ¶ç«¯å°è£
â”‚   â”œâ”€â”€ adminData.ts         # è³‡æ–™å±¤å°è£
â”‚   â””â”€â”€ supabaseServer.ts    # Service Role Client
â”‚
â””â”€â”€ app/api/admin/
    â”œâ”€â”€ dashboard/route.ts   # Dashboard API
    â”œâ”€â”€ users/route.ts       # ç”¨æˆ¶ç®¡ç† API
    â”œâ”€â”€ lessons/route.ts     # èª²ç¨‹åˆ†æ API
    â”œâ”€â”€ monetization/route.ts # ä»˜è²»åˆ†æ API
    â””â”€â”€ subscription/route.ts # è¨‚é–±é–‹é€š API

docs/
â”œâ”€â”€ migration_subscription_security.sql    # RLS æ”¿ç­–
â”œâ”€â”€ migration_event_log_guardrails.sql     # Rate limit
â”œâ”€â”€ migration_subscription_plans.sql       # æ–¹æ¡ˆç‰ˆæœ¬åŒ–
â””â”€â”€ SMOKE_AUTH_SUBSCRIPTION.md             # æ¸¬è©¦ç”¨ä¾‹
```

### ä¿®æ”¹æª”æ¡ˆ

```
web/src/app/admin/
â”œâ”€â”€ page.tsx              # æ”¹ç”¨ fetchAdminDashboard()
â”œâ”€â”€ users/page.tsx        # æ”¹ç”¨ fetchAdminUsers()
â”œâ”€â”€ lessons/page.tsx      # æ”¹ç”¨ fetchAdminLessons()
â”œâ”€â”€ monetization/page.tsx # æ”¹ç”¨ fetchAdminMonetization()
â””â”€â”€ feedback/page.tsx     # ä¿æŒåŸæ¨£ï¼ˆç„¡æ•æ„Ÿè³‡æ–™ï¼‰
```

---

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶

- [x] æ‰€æœ‰ admin é é¢æ­£å¸¸é‹ä½œ
- [x] æ•æ„Ÿè³‡æ–™ç„¡æ³•å¾å‰ç«¯ç›´æ¥å­˜å–
- [x] RLS æ”¿ç­–ç”Ÿæ•ˆï¼ˆpremium éœ€è¨‚é–±ï¼‰
- [x] Rate limit ç”Ÿæ•ˆï¼ˆevent_log é™åˆ¶ï¼‰
- [x] è¨‚é–±æª¢æŸ¥ä½¿ç”¨ä¼ºæœå™¨æ™‚é–“
- [x] Build æˆåŠŸé€šé

### å®‰å…¨é©—æ”¶

- [x] å‰ç«¯ç„¡ service role key
- [x] å‰ç«¯ç„¡ç›´æ¥ Supabase æŸ¥è©¢ï¼ˆadmin ç›¸é—œï¼‰
- [x] API éƒ½æœ‰ is_admin æª¢æŸ¥
- [x] RLS æ”¿ç­–è¦†è“‹æ‰€æœ‰æ•æ„Ÿè¡¨
- [x] Smoke Tests æ–‡ä»¶å®Œæ•´

### ç¨‹å¼ç¢¼å“è³ª

- [x] ç„¡ console.log
- [x] å‹åˆ¥çµ±ä¸€ä½¿ç”¨ lesson-v3.ts
- [x] ç„¡é‡è¤‡ä»£ç¢¼
- [x] çµ±ä¸€éŒ¯èª¤è™•ç†

---

## ğŸš€ å¾ŒçºŒå»ºè­°

### çŸ­æœŸï¼ˆ1-2 é€±ï¼‰

1. **åŸ·è¡Œ Smoke Tests**
   - æŒ‰ç…§ `SMOKE_AUTH_SUBSCRIPTION.md` æ¸¬è©¦æ‰€æœ‰å ´æ™¯
   - ç¢ºèª RLS æ”¿ç­–ç”Ÿæ•ˆ

2. **ç›£æ§ event_log**
   - è§€å¯Ÿæ˜¯å¦æœ‰ rate-limit è§¸ç™¼
   - èª¿æ•´é–¾å€¼ï¼ˆç›®å‰ 120 æ¬¡/åˆ†é˜ï¼‰

3. **æ–¹æ¡ˆè¡¨åŒæ­¥**
   - ç¢ºèª DB æ–¹æ¡ˆè¡¨èˆ‡å‰ç«¯å¸¸æ•¸ä¸€è‡´
   - å»ºç«‹åŒæ­¥æµç¨‹ï¼ˆæ‰‹å‹•æˆ–è‡ªå‹•ï¼‰

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰

1. **è‡ªå‹•åŒ–æ¸¬è©¦**
   - å°‡ Smoke Tests æ”¹ç‚ºè‡ªå‹•åŒ–æ¸¬è©¦
   - æ•´åˆåˆ° CI/CD

2. **ç›£æ§å‘Šè­¦**
   - è¨­å®š rate-limit è§¸ç™¼å‘Šè­¦
   - è¨­å®šç•°å¸¸è¨‚é–±æª¢æŸ¥å‘Šè­¦

3. **æ•ˆèƒ½å„ªåŒ–**
   - ç›£æ§ API å›æ‡‰æ™‚é–“
   - å¿…è¦æ™‚åŠ å…¥å¿«å–

### é•·æœŸï¼ˆ3-6 æœˆï¼‰

1. **å¯©è¨ˆæ—¥èªŒ**
   - è¨˜éŒ„æ‰€æœ‰ admin æ“ä½œ
   - å»ºç«‹å¯©è¨ˆè¿½è¹¤

2. **æ¬Šé™ç´°åˆ†**
   - å€åˆ† admin æ¬Šé™ç­‰ç´š
   - æ”¯æ´å¤šè§’è‰²ç®¡ç†

3. **å®‰å…¨æƒæ**
   - å®šæœŸåŸ·è¡Œå®‰å…¨æƒæ
   - æ›´æ–°ä¾è³´å¥—ä»¶

---

## ğŸ“š åƒè€ƒè³‡æ–™

- [Supabase RLS æ–‡ä»¶](https://supabase.com/docs/guides/auth/row-level-security)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [Clean Code åŸå‰‡](https://github.com/ryanmcdermott/clean-code-javascript)
- [Linus åŸå‰‡](https://en.wikipedia.org/wiki/Linus%27s_law)

---

## ğŸ‘¥ è²¢ç»è€…

- **é–‹ç™¼**ï¼šJames Chen
- **æ—¥æœŸ**ï¼š2025-12-01
- **é …ç›®**ï¼šClean Code + Linus é‡æ§‹è¡Œå‹•ï¼ˆ125-130ï¼‰

---

*æœ¬å ±å‘Šè¨˜éŒ„äº†é …ç›® 125-130 çš„å®Œæ•´æ”¹å–„éç¨‹ï¼Œä¾›æœªä¾†åƒè€ƒå’Œç¶­è­·ä½¿ç”¨ã€‚*
