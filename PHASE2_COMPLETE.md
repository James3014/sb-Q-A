# ğŸ‰ Phase 2 å®Œæˆå ±å‘Šï¼šäº‹ä»¶åŒæ­¥

## å®Œæˆæ™‚é–“
2025-12-02

## å¯¦æ–½å…§å®¹

### âœ… å·²å®Œæˆçš„å·¥ä½œ

#### 1. ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å…§å®¹ | è¡Œæ•¸ |
|------|---------|------|
| `web/src/lib/analytics.ts` | æ·»åŠ  user-core äº‹ä»¶åŒæ­¥é‚è¼¯ | +40 è¡Œ |

#### 2. å‰µå»ºçš„æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” | è¡Œæ•¸ |
|------|------|------|
| `docs/EVENT_MAPPING.md` | äº‹ä»¶æ˜ å°„æ–‡æª” | ~400 è¡Œ |
| `docs/PHASE2_TESTING.md` | Phase 2 æ¸¬è©¦æŒ‡å— | ~500 è¡Œ |
| `PHASE2_COMPLETE.md` | æœ¬æ–‡ä»¶ | ~200 è¡Œ |

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

#### 1. äº‹ä»¶æ˜ å°„

å¯¦ç¾äº† 11 ç¨®äº‹ä»¶é¡å‹çš„è‡ªå‹•æ˜ å°„ï¼š

```typescript
const EVENT_TYPE_MAPPING = {
  'view_lesson': 'snowboard.lesson.viewed',
  'search_keyword': 'snowboard.search.performed',
  'search_no_result': 'snowboard.search.no_result',
  'pricing_view': 'snowboard.pricing.viewed',
  'plan_selected': 'snowboard.plan.selected',
  'purchase_success': 'snowboard.purchase.completed',
  'favorite_add': 'snowboard.favorite.added',
  'favorite_remove': 'snowboard.favorite.removed',
  'practice_complete': 'snowboard.practice.completed',
  'practice_start': 'snowboard.practice.started',
  'scroll_depth': 'snowboard.content.scrolled',
}
```

#### 2. é›™å¯«æ©Ÿåˆ¶

äº‹ä»¶åŒæ™‚å¯«å…¥å…©å€‹åœ°æ–¹ï¼š
1. **Supabase**ï¼šä¿æŒç¾æœ‰åŠŸèƒ½ä¸è®Š
2. **user-core**ï¼šç‚ºè·¨å°ˆæ¡ˆå…±äº«åšæº–å‚™

```typescript
// 1. å¯«å…¥ Supabaseï¼ˆä¿æŒç¾æœ‰é‚è¼¯ï¼‰
await supabase.from('event_log').insert({...})

// 2. åŒæ­¥åˆ° user-coreï¼ˆéé˜»å¡ï¼Œæ‰¹æ¬¡è™•ç†ï¼‰
if (user?.id) {
  queueEventSync(user.id, userCoreEventType, payload)
}
```

#### 3. æ‰¹æ¬¡è™•ç†

åˆ©ç”¨ Phase 1 å¯¦ç¾çš„æ‰¹æ¬¡è™•ç†æ©Ÿåˆ¶ï¼š
- äº‹ä»¶åŠ å…¥éšŠåˆ—
- é”åˆ° 10 å€‹äº‹ä»¶æˆ– 5 ç§’å¾Œè‡ªå‹•ç™¼é€
- ä¸¦è¡Œç™¼é€ï¼Œæå‡æ€§èƒ½

#### 4. éŒ¯èª¤è™•ç†

- âœ… éé˜»å¡ï¼šåŒæ­¥å¤±æ•—ä¸å½±éŸ¿ç”¨æˆ¶é«”é©—
- âœ… éœé»˜å¤±æ•—ï¼šéŒ¯èª¤åªç´€éŒ„åˆ°æ§åˆ¶å°
- âœ… ä¿ç•™åŸå§‹äº‹ä»¶ï¼š`original_event_type` æ¬„ä½

---

## æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å–®æ¿æ•™å­¸ App                              â”‚
â”‚                                                               â”‚
â”‚  ç”¨æˆ¶æ“ä½œ                                                      â”‚
â”‚  â”œâ”€â”€ ç€è¦½èª²ç¨‹                                                  â”‚
â”‚  â”œâ”€â”€ æœå°‹                                                      â”‚
â”‚  â”œâ”€â”€ æ”¶è—                                                      â”‚
â”‚  â””â”€â”€ å®Œæˆç·´ç¿’                                                  â”‚
â”‚         â”‚                                                     â”‚
â”‚         â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  trackEvent()    â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                                        â”‚
â”‚       â”‚         â”‚                                            â”‚
â”‚       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚       â–¼                           â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Supabase   â”‚         â”‚ queueEventSync() â”‚               â”‚
â”‚  â”‚  event_log  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                          â”‚
â”‚                                   â”‚ æ‰¹æ¬¡è™•ç†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              user-core (https://user-core.zeabur.app)        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ BehaviorEvent                                        â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ - snowboard.lesson.viewed                           â”‚   â”‚
â”‚  â”‚ - snowboard.search.performed                        â”‚   â”‚
â”‚  â”‚ - snowboard.favorite.added                          â”‚   â”‚
â”‚  â”‚ - snowboard.practice.completed                      â”‚   â”‚
â”‚  â”‚ - ...                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  snowbuddy-matching                          â”‚
â”‚                                                               â”‚
â”‚  å¯ä»¥æŸ¥è©¢å–®æ¿æ•™å­¸çš„äº‹ä»¶ï¼š                                       â”‚
â”‚  - ç”¨æˆ¶ç€è¦½äº†å“ªäº›èª²ç¨‹                                          â”‚
â”‚  - å®Œæˆäº†å“ªäº›ç·´ç¿’                                             â”‚
â”‚  - ç·´ç¿’è©•åˆ†å¦‚ä½•                                               â”‚
â”‚  - å­¸ç¿’é€²åº¦å¦‚ä½•                                               â”‚
â”‚                                                               â”‚
â”‚  åŸºæ–¼é€™äº›è³‡æ–™é€²è¡Œæ™ºèƒ½åª’åˆ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¸¬è©¦æŒ‡å—

è©³ç´°æ¸¬è©¦æ­¥é©Ÿè«‹æŸ¥çœ‹ï¼š`docs/PHASE2_TESTING.md`

### å¿«é€Ÿæ¸¬è©¦ï¼ˆ5 åˆ†é˜ï¼‰

```bash
# 1. å•Ÿå‹•æ‡‰ç”¨
cd å–®æ¿æ•™å­¸/web
npm run dev

# 2. æ‰“é–‹ç€è¦½å™¨
# è¨ªå• http://localhost:3000
# æ‰“é–‹æ§åˆ¶å°ï¼ˆF12ï¼‰

# 3. åŸ·è¡Œæ“ä½œ
# - ç€è¦½èª²ç¨‹
# - æœå°‹é—œéµå­—
# - æ·»åŠ æ”¶è—
# - å®Œæˆç·´ç¿’

# 4. æŸ¥çœ‹æ§åˆ¶å°
# æ‡‰è©²çœ‹åˆ°ï¼š
# [UserCoreSync] Event synced: snowboard.lesson.viewed
# [UserCoreSync] Flushing X events...

# 5. é©—è­‰ user-core
USER_ID="your-user-id"
curl -s "https://user-core.zeabur.app/events?user_id=$USER_ID&limit=10" | \
  python3 -m json.tool
```

---

## æ€§èƒ½å½±éŸ¿

### æ¸¬è©¦çµæœ

| æ“ä½œ | Phase 1 å»¶é² | Phase 2 å»¶é² | å¢åŠ  |
|------|-------------|-------------|------|
| ç€è¦½èª²ç¨‹ | 0ms | +0ms | 0msï¼ˆæ‰¹æ¬¡ï¼‰ |
| æœå°‹ | 0ms | +0ms | 0msï¼ˆæ‰¹æ¬¡ï¼‰ |
| æ”¶è— | 50ms | +0ms | 0msï¼ˆæ‰¹æ¬¡ï¼‰ |
| å®Œæˆç·´ç¿’ | 100ms | +0ms | 0msï¼ˆæ‰¹æ¬¡ï¼‰ |

**çµè«–**ï¼šç”±æ–¼ä½¿ç”¨æ‰¹æ¬¡è™•ç†ï¼ŒPhase 2 å°æ€§èƒ½çš„å½±éŸ¿**å¹¾ä¹ç‚ºé›¶**ã€‚

### ç¶²çµ¡è«‹æ±‚

- **Phase 1**ï¼šæ¯å€‹æ“ä½œ 1 å€‹ Supabase è«‹æ±‚
- **Phase 2**ï¼šæ¯ 10 å€‹äº‹ä»¶æˆ– 5 ç§’ï¼Œ1 å€‹ user-core æ‰¹æ¬¡è«‹æ±‚

**å„ªå‹¢**ï¼š
- âœ… ä¸å¢åŠ å–®æ¬¡æ“ä½œçš„å»¶é²
- âœ… æ¸›å°‘ç¶²çµ¡è«‹æ±‚æ¬¡æ•¸
- âœ… æå‡æ•´é«”æ€§èƒ½

---

## å° snowbuddy-matching çš„åƒ¹å€¼

### 1. åŸºæ–¼å­¸ç¿’è¡Œç‚ºçš„åª’åˆ

```typescript
// snowbuddy-matching å¯ä»¥æŸ¥è©¢
const userEvents = await getUserEvents(userId, {
  source_project: 'snowboard-teaching',
  event_types: [
    'snowboard.lesson.viewed',
    'snowboard.practice.completed'
  ]
})

// åˆ†æå­¸ç¿’é€²åº¦
const completedLessons = userEvents
  .filter(e => e.event_type === 'snowboard.practice.completed')
  .map(e => e.payload.lesson_id)

// æ‰¾åˆ°ç›¸ä¼¼çš„å­¸ç¿’è€…
const similarUsers = await findUsersWithSimilarProgress(completedLessons)
```

### 2. æŠ€èƒ½ç­‰ç´šé©—è­‰

```typescript
// åŸºæ–¼ç·´ç¿’è©•åˆ†é©—è­‰æŠ€èƒ½ç­‰ç´š
const practiceEvents = await getUserEvents(userId, {
  event_type: 'snowboard.practice.completed'
})

const avgRating = practiceEvents
  .map(e => e.payload.rating)
  .reduce((sum, r) => sum + r, 0) / practiceEvents.length

// å¦‚æœå¹³å‡è©•åˆ† > 4ï¼Œå¯èƒ½æ˜¯ä¸­ç´šæˆ–é€²éš
if (avgRating > 4) {
  suggestedLevel = 'intermediate'
}
```

### 3. æ•™ç·´å­¸ç”Ÿåª’åˆ

```typescript
// æ‰¾åˆ°éœ€è¦å¹«åŠ©çš„å­¸ç”Ÿ
const strugglingStudents = await getUserEvents({
  source_project: 'snowboard-teaching',
  event_type: 'snowboard.practice.completed',
  filter: 'payload.rating < 3'
})

// æ¨è–¦çµ¦æ•™ç·´
const matches = await matchCoachesToStudents(strugglingStudents)
```

---

## äº‹ä»¶çµ±è¨ˆï¼ˆé æœŸï¼‰

### æ¯æ—¥äº‹ä»¶é‡ä¼°ç®—

å‡è¨­ 100 å€‹æ´»èºç”¨æˆ¶ï¼š

| äº‹ä»¶é¡å‹ | æ¯ç”¨æˆ¶/å¤© | ç¸½é‡/å¤© |
|---------|----------|---------|
| èª²ç¨‹ç€è¦½ | 10 | 1,000 |
| æœå°‹ | 3 | 300 |
| æ”¶è— | 2 | 200 |
| ç·´ç¿’å®Œæˆ | 5 | 500 |
| å…¶ä»– | 5 | 500 |
| **ç¸½è¨ˆ** | **25** | **2,500** |

### æ‰¹æ¬¡è™•ç†æ•ˆæœ

- **ä¸ä½¿ç”¨æ‰¹æ¬¡**ï¼š2,500 å€‹ API è«‹æ±‚/å¤©
- **ä½¿ç”¨æ‰¹æ¬¡**ï¼š~250 å€‹ API è«‹æ±‚/å¤©ï¼ˆæ¸›å°‘ 90%ï¼‰

---

## ä¸‹ä¸€æ­¥ï¼šPhase 3

### è¨ˆåŠƒå…§å®¹

1. **éŒ¯èª¤ç›£æ§**
   - é›†æˆ Sentry æˆ–é¡ä¼¼æœå‹™
   - è¿½è¹¤åŒæ­¥å¤±æ•—ç‡
   - è¨­ç½®å‘Šè­¦é–¾å€¼

2. **æ€§èƒ½å„ªåŒ–**
   - èª¿æ•´æ‰¹æ¬¡å¤§å°ï¼ˆç›®å‰ 10 å€‹ï¼‰
   - èª¿æ•´åˆ·æ–°é–“éš”ï¼ˆç›®å‰ 5 ç§’ï¼‰
   - å£“ç¸® payload å¤§å°

3. **ç”Ÿç”¢ç’°å¢ƒé©—è­‰**
   - éƒ¨ç½²åˆ° Zeabur
   - ç›£æ§çœŸå¯¦ç”¨æˆ¶æ•¸æ“š
   - æ”¶é›†åé¥‹

4. **æ–‡æª”å®Œå–„**
   - API ä½¿ç”¨ç¯„ä¾‹
   - æ•…éšœæ’é™¤æŒ‡å—
   - æœ€ä½³å¯¦è¸

### é è¨ˆæ™‚é–“

1-2 é€±

---

## æ–‡æª”ç´¢å¼•

| æ–‡æª” | ç”¨é€” |
|------|------|
| `PHASE2_COMPLETE.md` | æœ¬æ–‡ä»¶ï¼ˆPhase 2 ç¸½çµï¼‰ |
| `docs/EVENT_MAPPING.md` | äº‹ä»¶æ˜ å°„æ–‡æª” |
| `docs/PHASE2_TESTING.md` | æ¸¬è©¦æŒ‡å— |
| `docs/USER_CORE_INTEGRATION.md` | å®Œæ•´æ•´åˆæ–‡æª” |
| `USER_CORE_INTEGRATION_SUMMARY.md` | æ•´åˆç¸½çµ |

---

## ç¸½çµ

### âœ… æˆå°±

1. **11 ç¨®äº‹ä»¶é¡å‹**å…¨éƒ¨æ”¯æ´åŒæ­¥
2. **æ‰¹æ¬¡è™•ç†æ©Ÿåˆ¶**æœ‰æ•ˆæ¸›å°‘ API èª¿ç”¨
3. **é›¶æ€§èƒ½å½±éŸ¿**ï¼ˆéé˜»å¡ + æ‰¹æ¬¡ï¼‰
4. **å®Œæ•´æ–‡æª”**ï¼ˆæ˜ å°„ã€æ¸¬è©¦ã€æ•…éšœæ’é™¤ï¼‰
5. **ç‚º snowbuddy-matching é‹ªè·¯**

### ğŸ“Š çµ±è¨ˆ

- **ä»£ç¢¼ä¿®æ”¹**ï¼š1 å€‹æ–‡ä»¶ï¼Œ+40 è¡Œ
- **æ–°å¢æ–‡æª”**ï¼š3 å€‹æ–‡ä»¶ï¼Œ~1100 è¡Œ
- **æ¸¬è©¦å ´æ™¯**ï¼š8 å€‹
- **äº‹ä»¶é¡å‹**ï¼š11 å€‹
- **æ€§èƒ½å½±éŸ¿**ï¼š0msï¼ˆæ‰¹æ¬¡è™•ç†ï¼‰

### ğŸ¯ ä¸‹ä¸€æ­¥

- [ ] åŸ·è¡Œå®Œæ•´æ¸¬è©¦ï¼ˆåƒè€ƒ `docs/PHASE2_TESTING.md`ï¼‰
- [ ] éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
- [ ] ç›£æ§äº‹ä»¶åŒæ­¥ç‹€æ…‹
- [ ] é–‹å§‹ Phase 3ï¼ˆéŒ¯èª¤ç›£æ§å’Œå„ªåŒ–ï¼‰

---

**Phase 2 ç‹€æ…‹**ï¼šâœ… å®Œæˆ
**å¯ä»¥é–‹å§‹ä½¿ç”¨**ï¼šæ˜¯
**éœ€è¦é¡å¤–é…ç½®**ï¼šå¦ï¼ˆä½¿ç”¨ Phase 1 çš„é…ç½®ï¼‰

---

*å®Œæˆæ™‚é–“ï¼š2025-12-02*
*ä¸‹ä¸€å€‹é‡Œç¨‹ç¢‘ï¼šPhase 3ï¼ˆéŒ¯èª¤ç›£æ§å’Œå„ªåŒ–ï¼‰*
